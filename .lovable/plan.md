

# Implement Real Two-Factor Authentication (TOTP)

## Overview

Replace the cosmetic 2FA toggle with a fully working TOTP-based two-factor authentication system using the built-in MFA APIs. Admins will scan a QR code with an authenticator app (Google Authenticator, 1Password, etc.), verify with a 6-digit code, and be challenged on every subsequent login.

## How It Works

**Enrollment (Settings)**
1. Admin toggles "Enable 2FA" in Settings
2. A QR code appears (generated by `supabase.auth.mfa.enroll()`)
3. Admin scans it with their authenticator app
4. Admin enters the 6-digit code to verify
5. On success, the factor is enrolled and the toggle locks to "enabled"

**Login Challenge**
1. Admin signs in with email/password as usual
2. After successful sign-in, the app checks if the user has an enrolled TOTP factor
3. If yes, a challenge screen appears asking for the 6-digit code
4. The code is verified via `supabase.auth.mfa.challengeAndVerify()`
5. Only after successful verification does the user proceed to the dashboard

**Unenrollment**
1. Admin toggles 2FA off in Settings
2. Confirmation prompt appears
3. On confirm, `supabase.auth.mfa.unenroll()` removes the factor

## Changes by File

### 1. New: `src/components/auth/MFAChallengeForm.tsx`

A standalone component shown after password login when MFA is enrolled:
- Uses the existing `InputOTP` component (already installed) for the 6-digit code input
- Calls `supabase.auth.mfa.challenge()` then `supabase.auth.mfa.verify()` 
- On success, navigates to `/post-auth`
- Styled to match the existing login form aesthetic (white card, Daze branding)

### 2. New: `src/components/settings/TwoFactorSetup.tsx`

An inline enrollment component shown inside SettingsDialog when the user toggles 2FA on:
- Calls `supabase.auth.mfa.enroll({ factorType: 'totp' })`
- Displays the returned QR code SVG
- Has a 6-digit OTP input for verification
- On successful verify, confirms enrollment
- Includes a "Cancel" button to abort enrollment

### 3. Modified: `src/components/settings/SettingsDialog.tsx`

- Replace the simple Switch toggle with logic that:
  - Checks actual MFA enrollment status via `supabase.auth.mfa.listFactors()`
  - When toggling ON: shows the `TwoFactorSetup` component inline
  - When toggling OFF: calls `supabase.auth.mfa.unenroll(factorId)` after confirmation
- Remove the `two_factor_enabled` profile field dependency (the source of truth is now the auth system's factor list, not the profiles table)

### 4. Modified: `src/components/auth/LoginForm.tsx`

- After successful `signIn()`, check for enrolled TOTP factors via `supabase.auth.mfa.listFactors()`
- If factors exist, instead of navigating to `/post-auth`, set local state to show the `MFAChallengeForm`
- The challenge form handles verification and navigation

### 5. Modified: `src/pages/Auth.tsx`

- No structural changes needed -- the `LoginForm` internally switches to the MFA challenge view when required

## Technical Details

### Supabase MFA API Flow

**Enroll:**
```typescript
const { data, error } = await supabase.auth.mfa.enroll({
  factorType: 'totp',
  friendlyName: 'Authenticator App'
});
// data.totp.qr_code -> SVG data URI for QR code
// data.id -> factor ID
```

**Challenge + Verify (login):**
```typescript
const { data: challenge } = await supabase.auth.mfa.challenge({ factorId });
const { data, error } = await supabase.auth.mfa.verify({
  factorId,
  challengeId: challenge.id,
  code: userEnteredCode
});
```

**Unenroll:**
```typescript
await supabase.auth.mfa.unenroll({ factorId });
```

**List factors:**
```typescript
const { data } = await supabase.auth.mfa.listFactors();
// data.totp -> array of enrolled TOTP factors
```

### No Database Changes Required

- The `two_factor_enabled` column on `profiles` becomes a UI convenience only (synced after enrollment for display purposes)
- The actual source of truth is Supabase Auth's internal factor storage
- No migrations needed

### Dependencies

- `input-otp` -- already installed
- `@supabase/supabase-js` MFA methods -- available in the installed version (v2.95)

### Files Summary

| File | Action |
|------|--------|
| `src/components/auth/MFAChallengeForm.tsx` | Create |
| `src/components/settings/TwoFactorSetup.tsx` | Create |
| `src/components/settings/SettingsDialog.tsx` | Modify |
| `src/components/auth/LoginForm.tsx` | Modify |

